<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edge TTS</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 14px;
    background: #f0f0f0;
    display: flex;
    justify-content: center;
    padding: 24px 16px;
    min-height: 100vh;
  }
  #app {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.12);
    width: 100%;
    max-width: 780px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: fit-content;
  }
  h1 { font-size: 20px; font-weight: 600; color: #1a1a2e; }
  .row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  label { color: #555; white-space: nowrap; }
  select, input[type=text] {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px 8px;
    font-size: 14px;
    background: #fff;
    color: #222;
    outline: none;
    transition: border-color 0.15s;
  }
  select:focus, input[type=text]:focus { border-color: #0078d4; }
  #voiceSelect { flex: 1; min-width: 220px; }
  #filterInput { width: 165px; }
  #outputName { width: 170px; }
  button {
    padding: 5px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #f5f5f5;
    color: #222;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s, border-color 0.15s;
  }
  button:hover:not(:disabled) { background: #e5e5e5; border-color: #aaa; }
  button:disabled { opacity: 0.4; cursor: default; }
  #convertBtn {
    background: #0078d4; color: #fff;
    border-color: #0066b8; font-weight: 500;
  }
  #convertBtn:hover:not(:disabled) { background: #106ebe; }
  #speakBtn {
    background: #107c10; color: #fff;
    border-color: #0b6a0b; font-weight: 500;
  }
  #speakBtn:hover:not(:disabled) { background: #0b6a0b; }
  #stopBtn { background: #d83b01; color: #fff; border-color: #b83301; }
  #stopBtn:hover:not(:disabled) { background: #b83301; }
  textarea {
    width: 100%; height: 240px;
    border: 1px solid #ccc; border-radius: 4px;
    padding: 8px;
    font-size: 14px;
    font-family: Consolas, "Courier New", monospace;
    resize: vertical; outline: none; color: #222;
    transition: border-color 0.15s;
  }
  textarea:focus { border-color: #0078d4; }
  #status {
    font-size: 13px; color: #555;
    background: #f5f5f5;
    border: 1px solid #ddd; border-radius: 4px;
    padding: 4px 8px; min-height: 26px;
  }
  #status.error { color: #c50f1f; }
  #status.ok { color: #107c10; }
  .ml-auto { margin-left: auto; }
  .section-label { display: block; margin-bottom: 4px; color: #555; }
</style>
</head>
<body>
<div id="app">
  <h1>Edge TTS</h1>

  <!-- Voice row -->
  <div class="row">
    <label for="voiceSelect">Voice:</label>
    <select id="voiceSelect"></select>
    <label for="filterInput">Filter:</label>
    <input id="filterInput" type="text" value="en-US, zh-CN, zh-HK" placeholder="e.g. en-US, ja-JP">
    <button onclick="applyFilter()">Apply</button>
    <button onclick="showAll()">All</button>
  </div>

  <!-- Text area -->
  <div>
    <label class="section-label">Text to convert:</label>
    <textarea id="textArea" placeholder="Type or paste text here, or load a .txt file..."></textarea>
  </div>

  <!-- Buttons row -->
  <div class="row">
    <button onclick="loadFile()">Load .txt file</button>
    <button onclick="document.getElementById('textArea').value=''">Clear</button>
    <button id="speakBtn" onclick="startSpeak()">&#9654; Speak</button>
    <button id="stopBtn" onclick="stopSpeak()" disabled>&#9646;&#9646; Stop</button>
    <span class="ml-auto" style="display:flex;align-items:center;gap:6px">
      <label for="outputName">Save as:</label>
      <input id="outputName" type="text" value="output.mp3">
      <button id="convertBtn" onclick="convertToMp3()">Convert to MP3</button>
    </span>
  </div>

  <!-- Status bar -->
  <div id="status">Ready &mdash; select a voice and enter text to begin.</div>
</div>

<script>
// ── Config ─────────────────────────────────────────────────────────────────
const TOKEN   = '6A5AA1D4EAFF4E9FB37E23D68491D6F4';
const WS_BASE = 'wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1';

// ── Embedded voice list (322 voices, fetched at build time) ────────────────
const VOICES = [{"s": "af-ZA-AdriNeural", "g": "F", "l": "af-ZA"}, {"s": "af-ZA-WillemNeural", "g": "M", "l": "af-ZA"}, {"s": "sq-AL-AnilaNeural", "g": "F", "l": "sq-AL"}, {"s": "sq-AL-IlirNeural", "g": "M", "l": "sq-AL"}, {"s": "am-ET-AmehaNeural", "g": "M", "l": "am-ET"}, {"s": "am-ET-MekdesNeural", "g": "F", "l": "am-ET"}, {"s": "ar-DZ-AminaNeural", "g": "F", "l": "ar-DZ"}, {"s": "ar-DZ-IsmaelNeural", "g": "M", "l": "ar-DZ"}, {"s": "ar-BH-AliNeural", "g": "M", "l": "ar-BH"}, {"s": "ar-BH-LailaNeural", "g": "F", "l": "ar-BH"}, {"s": "ar-EG-SalmaNeural", "g": "F", "l": "ar-EG"}, {"s": "ar-EG-ShakirNeural", "g": "M", "l": "ar-EG"}, {"s": "ar-IQ-BasselNeural", "g": "M", "l": "ar-IQ"}, {"s": "ar-IQ-RanaNeural", "g": "F", "l": "ar-IQ"}, {"s": "ar-JO-SanaNeural", "g": "F", "l": "ar-JO"}, {"s": "ar-JO-TaimNeural", "g": "M", "l": "ar-JO"}, {"s": "ar-KW-FahedNeural", "g": "M", "l": "ar-KW"}, {"s": "ar-KW-NouraNeural", "g": "F", "l": "ar-KW"}, {"s": "ar-LB-LaylaNeural", "g": "F", "l": "ar-LB"}, {"s": "ar-LB-RamiNeural", "g": "M", "l": "ar-LB"}, {"s": "ar-LY-ImanNeural", "g": "F", "l": "ar-LY"}, {"s": "ar-LY-OmarNeural", "g": "M", "l": "ar-LY"}, {"s": "ar-MA-JamalNeural", "g": "M", "l": "ar-MA"}, {"s": "ar-MA-MounaNeural", "g": "F", "l": "ar-MA"}, {"s": "ar-OM-AbdullahNeural", "g": "M", "l": "ar-OM"}, {"s": "ar-OM-AyshaNeural", "g": "F", "l": "ar-OM"}, {"s": "ar-QA-AmalNeural", "g": "F", "l": "ar-QA"}, {"s": "ar-QA-MoazNeural", "g": "M", "l": "ar-QA"}, {"s": "ar-SA-HamedNeural", "g": "M", "l": "ar-SA"}, {"s": "ar-SA-ZariyahNeural", "g": "F", "l": "ar-SA"}, {"s": "ar-SY-AmanyNeural", "g": "F", "l": "ar-SY"}, {"s": "ar-SY-LaithNeural", "g": "M", "l": "ar-SY"}, {"s": "ar-TN-HediNeural", "g": "M", "l": "ar-TN"}, {"s": "ar-TN-ReemNeural", "g": "F", "l": "ar-TN"}, {"s": "ar-AE-FatimaNeural", "g": "F", "l": "ar-AE"}, {"s": "ar-AE-HamdanNeural", "g": "M", "l": "ar-AE"}, {"s": "ar-YE-MaryamNeural", "g": "F", "l": "ar-YE"}, {"s": "ar-YE-SalehNeural", "g": "M", "l": "ar-YE"}, {"s": "az-AZ-BabekNeural", "g": "M", "l": "az-AZ"}, {"s": "az-AZ-BanuNeural", "g": "F", "l": "az-AZ"}, {"s": "bn-BD-NabanitaNeural", "g": "F", "l": "bn-BD"}, {"s": "bn-BD-PradeepNeural", "g": "M", "l": "bn-BD"}, {"s": "bn-IN-BashkarNeural", "g": "M", "l": "bn-IN"}, {"s": "bn-IN-TanishaaNeural", "g": "F", "l": "bn-IN"}, {"s": "bs-BA-VesnaNeural", "g": "F", "l": "bs-BA"}, {"s": "bs-BA-GoranNeural", "g": "M", "l": "bs-BA"}, {"s": "bg-BG-BorislavNeural", "g": "M", "l": "bg-BG"}, {"s": "bg-BG-KalinaNeural", "g": "F", "l": "bg-BG"}, {"s": "my-MM-NilarNeural", "g": "F", "l": "my-MM"}, {"s": "my-MM-ThihaNeural", "g": "M", "l": "my-MM"}, {"s": "ca-ES-EnricNeural", "g": "M", "l": "ca-ES"}, {"s": "ca-ES-JoanaNeural", "g": "F", "l": "ca-ES"}, {"s": "zh-HK-HiuGaaiNeural", "g": "F", "l": "zh-HK"}, {"s": "zh-HK-HiuMaanNeural", "g": "F", "l": "zh-HK"}, {"s": "zh-HK-WanLungNeural", "g": "M", "l": "zh-HK"}, {"s": "zh-CN-XiaoxiaoNeural", "g": "F", "l": "zh-CN"}, {"s": "zh-CN-XiaoyiNeural", "g": "F", "l": "zh-CN"}, {"s": "zh-CN-YunjianNeural", "g": "M", "l": "zh-CN"}, {"s": "zh-CN-YunxiNeural", "g": "M", "l": "zh-CN"}, {"s": "zh-CN-YunxiaNeural", "g": "M", "l": "zh-CN"}, {"s": "zh-CN-YunyangNeural", "g": "M", "l": "zh-CN"}, {"s": "zh-CN-liaoning-XiaobeiNeural", "g": "F", "l": "zh-CN-liaoning"}, {"s": "zh-TW-HsiaoChenNeural", "g": "F", "l": "zh-TW"}, {"s": "zh-TW-YunJheNeural", "g": "M", "l": "zh-TW"}, {"s": "zh-TW-HsiaoYuNeural", "g": "F", "l": "zh-TW"}, {"s": "zh-CN-shaanxi-XiaoniNeural", "g": "F", "l": "zh-CN-shaanxi"}, {"s": "hr-HR-GabrijelaNeural", "g": "F", "l": "hr-HR"}, {"s": "hr-HR-SreckoNeural", "g": "M", "l": "hr-HR"}, {"s": "cs-CZ-AntoninNeural", "g": "M", "l": "cs-CZ"}, {"s": "cs-CZ-VlastaNeural", "g": "F", "l": "cs-CZ"}, {"s": "da-DK-ChristelNeural", "g": "F", "l": "da-DK"}, {"s": "da-DK-JeppeNeural", "g": "M", "l": "da-DK"}, {"s": "nl-BE-ArnaudNeural", "g": "M", "l": "nl-BE"}, {"s": "nl-BE-DenaNeural", "g": "F", "l": "nl-BE"}, {"s": "nl-NL-ColetteNeural", "g": "F", "l": "nl-NL"}, {"s": "nl-NL-FennaNeural", "g": "F", "l": "nl-NL"}, {"s": "nl-NL-MaartenNeural", "g": "M", "l": "nl-NL"}, {"s": "en-AU-WilliamMultilingualNeural", "g": "M", "l": "en-AU"}, {"s": "en-AU-NatashaNeural", "g": "F", "l": "en-AU"}, {"s": "en-CA-ClaraNeural", "g": "F", "l": "en-CA"}, {"s": "en-CA-LiamNeural", "g": "M", "l": "en-CA"}, {"s": "en-HK-YanNeural", "g": "F", "l": "en-HK"}, {"s": "en-HK-SamNeural", "g": "M", "l": "en-HK"}, {"s": "en-IN-NeerjaExpressiveNeural", "g": "F", "l": "en-IN"}, {"s": "en-IN-NeerjaNeural", "g": "F", "l": "en-IN"}, {"s": "en-IN-PrabhatNeural", "g": "M", "l": "en-IN"}, {"s": "en-IE-ConnorNeural", "g": "M", "l": "en-IE"}, {"s": "en-IE-EmilyNeural", "g": "F", "l": "en-IE"}, {"s": "en-KE-AsiliaNeural", "g": "F", "l": "en-KE"}, {"s": "en-KE-ChilembaNeural", "g": "M", "l": "en-KE"}, {"s": "en-NZ-MitchellNeural", "g": "M", "l": "en-NZ"}, {"s": "en-NZ-MollyNeural", "g": "F", "l": "en-NZ"}, {"s": "en-NG-AbeoNeural", "g": "M", "l": "en-NG"}, {"s": "en-NG-EzinneNeural", "g": "F", "l": "en-NG"}, {"s": "en-PH-JamesNeural", "g": "M", "l": "en-PH"}, {"s": "en-PH-RosaNeural", "g": "F", "l": "en-PH"}, {"s": "en-US-AvaNeural", "g": "F", "l": "en-US"}, {"s": "en-US-AndrewNeural", "g": "M", "l": "en-US"}, {"s": "en-US-EmmaNeural", "g": "F", "l": "en-US"}, {"s": "en-US-BrianNeural", "g": "M", "l": "en-US"}, {"s": "en-SG-LunaNeural", "g": "F", "l": "en-SG"}, {"s": "en-SG-WayneNeural", "g": "M", "l": "en-SG"}, {"s": "en-ZA-LeahNeural", "g": "F", "l": "en-ZA"}, {"s": "en-ZA-LukeNeural", "g": "M", "l": "en-ZA"}, {"s": "en-TZ-ElimuNeural", "g": "M", "l": "en-TZ"}, {"s": "en-TZ-ImaniNeural", "g": "F", "l": "en-TZ"}, {"s": "en-GB-LibbyNeural", "g": "F", "l": "en-GB"}, {"s": "en-GB-MaisieNeural", "g": "F", "l": "en-GB"}, {"s": "en-GB-RyanNeural", "g": "M", "l": "en-GB"}, {"s": "en-GB-SoniaNeural", "g": "F", "l": "en-GB"}, {"s": "en-GB-ThomasNeural", "g": "M", "l": "en-GB"}, {"s": "en-US-AnaNeural", "g": "F", "l": "en-US"}, {"s": "en-US-AndrewMultilingualNeural", "g": "M", "l": "en-US"}, {"s": "en-US-AriaNeural", "g": "F", "l": "en-US"}, {"s": "en-US-AvaMultilingualNeural", "g": "F", "l": "en-US"}, {"s": "en-US-BrianMultilingualNeural", "g": "M", "l": "en-US"}, {"s": "en-US-ChristopherNeural", "g": "M", "l": "en-US"}, {"s": "en-US-EmmaMultilingualNeural", "g": "F", "l": "en-US"}, {"s": "en-US-EricNeural", "g": "M", "l": "en-US"}, {"s": "en-US-GuyNeural", "g": "M", "l": "en-US"}, {"s": "en-US-JennyNeural", "g": "F", "l": "en-US"}, {"s": "en-US-MichelleNeural", "g": "F", "l": "en-US"}, {"s": "en-US-RogerNeural", "g": "M", "l": "en-US"}, {"s": "en-US-SteffanNeural", "g": "M", "l": "en-US"}, {"s": "et-EE-AnuNeural", "g": "F", "l": "et-EE"}, {"s": "et-EE-KertNeural", "g": "M", "l": "et-EE"}, {"s": "fil-PH-AngeloNeural", "g": "M", "l": "fil-PH"}, {"s": "fil-PH-BlessicaNeural", "g": "F", "l": "fil-PH"}, {"s": "fi-FI-HarriNeural", "g": "M", "l": "fi-FI"}, {"s": "fi-FI-NooraNeural", "g": "F", "l": "fi-FI"}, {"s": "fr-BE-CharlineNeural", "g": "F", "l": "fr-BE"}, {"s": "fr-BE-GerardNeural", "g": "M", "l": "fr-BE"}, {"s": "fr-CA-ThierryNeural", "g": "M", "l": "fr-CA"}, {"s": "fr-CA-AntoineNeural", "g": "M", "l": "fr-CA"}, {"s": "fr-CA-JeanNeural", "g": "M", "l": "fr-CA"}, {"s": "fr-CA-SylvieNeural", "g": "F", "l": "fr-CA"}, {"s": "fr-FR-VivienneMultilingualNeural", "g": "F", "l": "fr-FR"}, {"s": "fr-FR-RemyMultilingualNeural", "g": "M", "l": "fr-FR"}, {"s": "fr-FR-DeniseNeural", "g": "F", "l": "fr-FR"}, {"s": "fr-FR-EloiseNeural", "g": "F", "l": "fr-FR"}, {"s": "fr-FR-HenriNeural", "g": "M", "l": "fr-FR"}, {"s": "fr-CH-ArianeNeural", "g": "F", "l": "fr-CH"}, {"s": "fr-CH-FabriceNeural", "g": "M", "l": "fr-CH"}, {"s": "gl-ES-RoiNeural", "g": "M", "l": "gl-ES"}, {"s": "gl-ES-SabelaNeural", "g": "F", "l": "gl-ES"}, {"s": "ka-GE-EkaNeural", "g": "F", "l": "ka-GE"}, {"s": "ka-GE-GiorgiNeural", "g": "M", "l": "ka-GE"}, {"s": "de-AT-IngridNeural", "g": "F", "l": "de-AT"}, {"s": "de-AT-JonasNeural", "g": "M", "l": "de-AT"}, {"s": "de-DE-SeraphinaMultilingualNeural", "g": "F", "l": "de-DE"}, {"s": "de-DE-FlorianMultilingualNeural", "g": "M", "l": "de-DE"}, {"s": "de-DE-AmalaNeural", "g": "F", "l": "de-DE"}, {"s": "de-DE-ConradNeural", "g": "M", "l": "de-DE"}, {"s": "de-DE-KatjaNeural", "g": "F", "l": "de-DE"}, {"s": "de-DE-KillianNeural", "g": "M", "l": "de-DE"}, {"s": "de-CH-JanNeural", "g": "M", "l": "de-CH"}, {"s": "de-CH-LeniNeural", "g": "F", "l": "de-CH"}, {"s": "el-GR-AthinaNeural", "g": "F", "l": "el-GR"}, {"s": "el-GR-NestorasNeural", "g": "M", "l": "el-GR"}, {"s": "gu-IN-DhwaniNeural", "g": "F", "l": "gu-IN"}, {"s": "gu-IN-NiranjanNeural", "g": "M", "l": "gu-IN"}, {"s": "he-IL-AvriNeural", "g": "M", "l": "he-IL"}, {"s": "he-IL-HilaNeural", "g": "F", "l": "he-IL"}, {"s": "hi-IN-MadhurNeural", "g": "M", "l": "hi-IN"}, {"s": "hi-IN-SwaraNeural", "g": "F", "l": "hi-IN"}, {"s": "hu-HU-NoemiNeural", "g": "F", "l": "hu-HU"}, {"s": "hu-HU-TamasNeural", "g": "M", "l": "hu-HU"}, {"s": "is-IS-GudrunNeural", "g": "F", "l": "is-IS"}, {"s": "is-IS-GunnarNeural", "g": "M", "l": "is-IS"}, {"s": "id-ID-ArdiNeural", "g": "M", "l": "id-ID"}, {"s": "id-ID-GadisNeural", "g": "F", "l": "id-ID"}, {"s": "iu-Latn-CA-SiqiniqNeural", "g": "F", "l": "iu-Latn-CA"}, {"s": "iu-Latn-CA-TaqqiqNeural", "g": "M", "l": "iu-Latn-CA"}, {"s": "iu-Cans-CA-SiqiniqNeural", "g": "F", "l": "iu-Cans-CA"}, {"s": "iu-Cans-CA-TaqqiqNeural", "g": "M", "l": "iu-Cans-CA"}, {"s": "ga-IE-ColmNeural", "g": "M", "l": "ga-IE"}, {"s": "ga-IE-OrlaNeural", "g": "F", "l": "ga-IE"}, {"s": "it-IT-GiuseppeMultilingualNeural", "g": "M", "l": "it-IT"}, {"s": "it-IT-DiegoNeural", "g": "M", "l": "it-IT"}, {"s": "it-IT-ElsaNeural", "g": "F", "l": "it-IT"}, {"s": "it-IT-IsabellaNeural", "g": "F", "l": "it-IT"}, {"s": "ja-JP-KeitaNeural", "g": "M", "l": "ja-JP"}, {"s": "ja-JP-NanamiNeural", "g": "F", "l": "ja-JP"}, {"s": "jv-ID-DimasNeural", "g": "M", "l": "jv-ID"}, {"s": "jv-ID-SitiNeural", "g": "F", "l": "jv-ID"}, {"s": "kn-IN-GaganNeural", "g": "M", "l": "kn-IN"}, {"s": "kn-IN-SapnaNeural", "g": "F", "l": "kn-IN"}, {"s": "kk-KZ-AigulNeural", "g": "F", "l": "kk-KZ"}, {"s": "kk-KZ-DauletNeural", "g": "M", "l": "kk-KZ"}, {"s": "km-KH-PisethNeural", "g": "M", "l": "km-KH"}, {"s": "km-KH-SreymomNeural", "g": "F", "l": "km-KH"}, {"s": "ko-KR-HyunsuMultilingualNeural", "g": "M", "l": "ko-KR"}, {"s": "ko-KR-InJoonNeural", "g": "M", "l": "ko-KR"}, {"s": "ko-KR-SunHiNeural", "g": "F", "l": "ko-KR"}, {"s": "lo-LA-ChanthavongNeural", "g": "M", "l": "lo-LA"}, {"s": "lo-LA-KeomanyNeural", "g": "F", "l": "lo-LA"}, {"s": "lv-LV-EveritaNeural", "g": "F", "l": "lv-LV"}, {"s": "lv-LV-NilsNeural", "g": "M", "l": "lv-LV"}, {"s": "lt-LT-LeonasNeural", "g": "M", "l": "lt-LT"}, {"s": "lt-LT-OnaNeural", "g": "F", "l": "lt-LT"}, {"s": "mk-MK-AleksandarNeural", "g": "M", "l": "mk-MK"}, {"s": "mk-MK-MarijaNeural", "g": "F", "l": "mk-MK"}, {"s": "ms-MY-OsmanNeural", "g": "M", "l": "ms-MY"}, {"s": "ms-MY-YasminNeural", "g": "F", "l": "ms-MY"}, {"s": "ml-IN-MidhunNeural", "g": "M", "l": "ml-IN"}, {"s": "ml-IN-SobhanaNeural", "g": "F", "l": "ml-IN"}, {"s": "mt-MT-GraceNeural", "g": "F", "l": "mt-MT"}, {"s": "mt-MT-JosephNeural", "g": "M", "l": "mt-MT"}, {"s": "mr-IN-AarohiNeural", "g": "F", "l": "mr-IN"}, {"s": "mr-IN-ManoharNeural", "g": "M", "l": "mr-IN"}, {"s": "mn-MN-BataaNeural", "g": "M", "l": "mn-MN"}, {"s": "mn-MN-YesuiNeural", "g": "F", "l": "mn-MN"}, {"s": "ne-NP-HemkalaNeural", "g": "F", "l": "ne-NP"}, {"s": "ne-NP-SagarNeural", "g": "M", "l": "ne-NP"}, {"s": "nb-NO-FinnNeural", "g": "M", "l": "nb-NO"}, {"s": "nb-NO-PernilleNeural", "g": "F", "l": "nb-NO"}, {"s": "ps-AF-GulNawazNeural", "g": "M", "l": "ps-AF"}, {"s": "ps-AF-LatifaNeural", "g": "F", "l": "ps-AF"}, {"s": "fa-IR-DilaraNeural", "g": "F", "l": "fa-IR"}, {"s": "fa-IR-FaridNeural", "g": "M", "l": "fa-IR"}, {"s": "pl-PL-MarekNeural", "g": "M", "l": "pl-PL"}, {"s": "pl-PL-ZofiaNeural", "g": "F", "l": "pl-PL"}, {"s": "pt-BR-ThalitaMultilingualNeural", "g": "F", "l": "pt-BR"}, {"s": "pt-BR-AntonioNeural", "g": "M", "l": "pt-BR"}, {"s": "pt-BR-FranciscaNeural", "g": "F", "l": "pt-BR"}, {"s": "pt-PT-DuarteNeural", "g": "M", "l": "pt-PT"}, {"s": "pt-PT-RaquelNeural", "g": "F", "l": "pt-PT"}, {"s": "ro-RO-AlinaNeural", "g": "F", "l": "ro-RO"}, {"s": "ro-RO-EmilNeural", "g": "M", "l": "ro-RO"}, {"s": "ru-RU-DmitryNeural", "g": "M", "l": "ru-RU"}, {"s": "ru-RU-SvetlanaNeural", "g": "F", "l": "ru-RU"}, {"s": "sr-RS-NicholasNeural", "g": "M", "l": "sr-RS"}, {"s": "sr-RS-SophieNeural", "g": "F", "l": "sr-RS"}, {"s": "si-LK-SameeraNeural", "g": "M", "l": "si-LK"}, {"s": "si-LK-ThiliniNeural", "g": "F", "l": "si-LK"}, {"s": "sk-SK-LukasNeural", "g": "M", "l": "sk-SK"}, {"s": "sk-SK-ViktoriaNeural", "g": "F", "l": "sk-SK"}, {"s": "sl-SI-PetraNeural", "g": "F", "l": "sl-SI"}, {"s": "sl-SI-RokNeural", "g": "M", "l": "sl-SI"}, {"s": "so-SO-MuuseNeural", "g": "M", "l": "so-SO"}, {"s": "so-SO-UbaxNeural", "g": "F", "l": "so-SO"}, {"s": "es-AR-ElenaNeural", "g": "F", "l": "es-AR"}, {"s": "es-AR-TomasNeural", "g": "M", "l": "es-AR"}, {"s": "es-BO-MarceloNeural", "g": "M", "l": "es-BO"}, {"s": "es-BO-SofiaNeural", "g": "F", "l": "es-BO"}, {"s": "es-CL-CatalinaNeural", "g": "F", "l": "es-CL"}, {"s": "es-CL-LorenzoNeural", "g": "M", "l": "es-CL"}, {"s": "es-CO-GonzaloNeural", "g": "M", "l": "es-CO"}, {"s": "es-CO-SalomeNeural", "g": "F", "l": "es-CO"}, {"s": "es-ES-XimenaNeural", "g": "F", "l": "es-ES"}, {"s": "es-CR-JuanNeural", "g": "M", "l": "es-CR"}, {"s": "es-CR-MariaNeural", "g": "F", "l": "es-CR"}, {"s": "es-CU-BelkysNeural", "g": "F", "l": "es-CU"}, {"s": "es-CU-ManuelNeural", "g": "M", "l": "es-CU"}, {"s": "es-DO-EmilioNeural", "g": "M", "l": "es-DO"}, {"s": "es-DO-RamonaNeural", "g": "F", "l": "es-DO"}, {"s": "es-EC-AndreaNeural", "g": "F", "l": "es-EC"}, {"s": "es-EC-LuisNeural", "g": "M", "l": "es-EC"}, {"s": "es-SV-LorenaNeural", "g": "F", "l": "es-SV"}, {"s": "es-SV-RodrigoNeural", "g": "M", "l": "es-SV"}, {"s": "es-GQ-JavierNeural", "g": "M", "l": "es-GQ"}, {"s": "es-GQ-TeresaNeural", "g": "F", "l": "es-GQ"}, {"s": "es-GT-AndresNeural", "g": "M", "l": "es-GT"}, {"s": "es-GT-MartaNeural", "g": "F", "l": "es-GT"}, {"s": "es-HN-CarlosNeural", "g": "M", "l": "es-HN"}, {"s": "es-HN-KarlaNeural", "g": "F", "l": "es-HN"}, {"s": "es-MX-DaliaNeural", "g": "F", "l": "es-MX"}, {"s": "es-MX-JorgeNeural", "g": "M", "l": "es-MX"}, {"s": "es-NI-FedericoNeural", "g": "M", "l": "es-NI"}, {"s": "es-NI-YolandaNeural", "g": "F", "l": "es-NI"}, {"s": "es-PA-MargaritaNeural", "g": "F", "l": "es-PA"}, {"s": "es-PA-RobertoNeural", "g": "M", "l": "es-PA"}, {"s": "es-PY-MarioNeural", "g": "M", "l": "es-PY"}, {"s": "es-PY-TaniaNeural", "g": "F", "l": "es-PY"}, {"s": "es-PE-AlexNeural", "g": "M", "l": "es-PE"}, {"s": "es-PE-CamilaNeural", "g": "F", "l": "es-PE"}, {"s": "es-PR-KarinaNeural", "g": "F", "l": "es-PR"}, {"s": "es-PR-VictorNeural", "g": "M", "l": "es-PR"}, {"s": "es-ES-AlvaroNeural", "g": "M", "l": "es-ES"}, {"s": "es-ES-ElviraNeural", "g": "F", "l": "es-ES"}, {"s": "es-US-AlonsoNeural", "g": "M", "l": "es-US"}, {"s": "es-US-PalomaNeural", "g": "F", "l": "es-US"}, {"s": "es-UY-MateoNeural", "g": "M", "l": "es-UY"}, {"s": "es-UY-ValentinaNeural", "g": "F", "l": "es-UY"}, {"s": "es-VE-PaolaNeural", "g": "F", "l": "es-VE"}, {"s": "es-VE-SebastianNeural", "g": "M", "l": "es-VE"}, {"s": "su-ID-JajangNeural", "g": "M", "l": "su-ID"}, {"s": "su-ID-TutiNeural", "g": "F", "l": "su-ID"}, {"s": "sw-KE-RafikiNeural", "g": "M", "l": "sw-KE"}, {"s": "sw-KE-ZuriNeural", "g": "F", "l": "sw-KE"}, {"s": "sw-TZ-DaudiNeural", "g": "M", "l": "sw-TZ"}, {"s": "sw-TZ-RehemaNeural", "g": "F", "l": "sw-TZ"}, {"s": "sv-SE-MattiasNeural", "g": "M", "l": "sv-SE"}, {"s": "sv-SE-SofieNeural", "g": "F", "l": "sv-SE"}, {"s": "ta-IN-PallaviNeural", "g": "F", "l": "ta-IN"}, {"s": "ta-IN-ValluvarNeural", "g": "M", "l": "ta-IN"}, {"s": "ta-MY-KaniNeural", "g": "F", "l": "ta-MY"}, {"s": "ta-MY-SuryaNeural", "g": "M", "l": "ta-MY"}, {"s": "ta-SG-AnbuNeural", "g": "M", "l": "ta-SG"}, {"s": "ta-SG-VenbaNeural", "g": "F", "l": "ta-SG"}, {"s": "ta-LK-KumarNeural", "g": "M", "l": "ta-LK"}, {"s": "ta-LK-SaranyaNeural", "g": "F", "l": "ta-LK"}, {"s": "te-IN-MohanNeural", "g": "M", "l": "te-IN"}, {"s": "te-IN-ShrutiNeural", "g": "F", "l": "te-IN"}, {"s": "th-TH-NiwatNeural", "g": "M", "l": "th-TH"}, {"s": "th-TH-PremwadeeNeural", "g": "F", "l": "th-TH"}, {"s": "tr-TR-EmelNeural", "g": "F", "l": "tr-TR"}, {"s": "tr-TR-AhmetNeural", "g": "M", "l": "tr-TR"}, {"s": "uk-UA-OstapNeural", "g": "M", "l": "uk-UA"}, {"s": "uk-UA-PolinaNeural", "g": "F", "l": "uk-UA"}, {"s": "ur-IN-GulNeural", "g": "F", "l": "ur-IN"}, {"s": "ur-IN-SalmanNeural", "g": "M", "l": "ur-IN"}, {"s": "ur-PK-AsadNeural", "g": "M", "l": "ur-PK"}, {"s": "ur-PK-UzmaNeural", "g": "F", "l": "ur-PK"}, {"s": "uz-UZ-MadinaNeural", "g": "F", "l": "uz-UZ"}, {"s": "uz-UZ-SardorNeural", "g": "M", "l": "uz-UZ"}, {"s": "vi-VN-HoaiMyNeural", "g": "F", "l": "vi-VN"}, {"s": "vi-VN-NamMinhNeural", "g": "M", "l": "vi-VN"}, {"s": "cy-GB-AledNeural", "g": "M", "l": "cy-GB"}, {"s": "cy-GB-NiaNeural", "g": "F", "l": "cy-GB"}, {"s": "zu-ZA-ThandoNeural", "g": "F", "l": "zu-ZA"}, {"s": "zu-ZA-ThembaNeural", "g": "M", "l": "zu-ZA"}];

// ── State ──────────────────────────────────────────────────────────────────
let currentAudio = null;
let currentWs    = null;

// ── Helpers ────────────────────────────────────────────────────────────────
function uuid() {
  return 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'.replace(/x/g, () => (Math.random() * 16 | 0).toString(16));
}
function ts() { return new Date().toISOString(); }
function escXml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&apos;');
}
function setStatus(msg, cls) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = cls || '';
}

// ── Voice filter ───────────────────────────────────────────────────────────
function applyFilter() {
  const raw   = document.getElementById('filterInput').value.trim().toLowerCase();
  const parts = raw ? raw.split(',').map(p => p.trim()).filter(Boolean) : [];
  const list  = parts.length
    ? VOICES.filter(v => parts.some(p => v.l.toLowerCase().includes(p)))
    : VOICES;
  const sel = document.getElementById('voiceSelect');
  sel.innerHTML = '';
  list.forEach(v => {
    const opt = document.createElement('option');
    opt.value       = v.s;
    opt.textContent = v.s + '  (' + (v.g === 'F' ? 'Female' : 'Male') + ')';
    sel.appendChild(opt);
  });
  setStatus(list.length + ' voices shown.');
}

function showAll() {
  document.getElementById('filterInput').value = '';
  applyFilter();
}

function getVoice() { return document.getElementById('voiceSelect').value || null; }

// ── File load ──────────────────────────────────────────────────────────────
function loadFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.txt,text/plain';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById('textArea').value  = ev.target.result;
      document.getElementById('outputName').value = file.name.replace(/\.txt$/i, '.mp3');
      setStatus('Loaded: ' + file.name);
    };
    reader.readAsText(file, 'utf-8');
  };
  input.click();
}

// ── Core TTS via WebSocket ─────────────────────────────────────────────────
function tts(text, voice) {
  return new Promise((resolve, reject) => {
    const ws = new WebSocket(
      WS_BASE + '?TrustedClientToken=' + TOKEN + '&ConnectionId=' + uuid()
    );
    ws.binaryType = 'arraybuffer';
    currentWs = ws;
    const chunks = [];

    ws.onopen = () => {
      // Message 1: speech config
      ws.send(
        'X-Timestamp:' + ts() + '\r\n' +
        'Content-Type:application/json; charset=utf-8\r\n' +
        'Path:speech.config\r\n\r\n' +
        JSON.stringify({ context: { synthesis: { audio: {
          metadataoptions: { sentenceBoundaryEnabled: 'false', wordBoundaryEnabled: 'false' },
          outputFormat: 'audio-24khz-48kbitrate-mono-mp3'
        }}}})
      );
      // Message 2: SSML
      const ssml =
        "<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='en-US'>" +
        "<voice name='" + voice + "'>" + escXml(text) + '</voice></speak>';
      ws.send(
        'X-RequestId:' + uuid() + '\r\n' +
        'Content-Type:application/ssml+xml\r\n' +
        'X-Timestamp:' + ts() + '\r\n' +
        'Path:ssml\r\n\r\n' + ssml
      );
    };

    ws.onmessage = e => {
      if (typeof e.data === 'string') {
        if (e.data.includes('Path:turn.end')) {
          ws.close();
          currentWs = null;
          resolve(new Blob(chunks, { type: 'audio/mpeg' }));
        }
      } else {
        // Binary frame: [2-byte header length][header text][audio bytes]
        const headerLen = new DataView(e.data).getUint16(0);
        const header    = new TextDecoder().decode(new Uint8Array(e.data, 2, headerLen));
        if (header.includes('Path:audio')) {
          chunks.push(new Uint8Array(e.data, 2 + headerLen));
        }
      }
    };

    ws.onerror = () => { currentWs = null; reject(new Error('WebSocket error — check your internet connection.')); };
    ws.onclose = ev => {
      currentWs = null;
      if (!ev.wasClean && chunks.length === 0)
        reject(new Error('Connection closed before audio was received.'));
    };
  });
}

// ── Speak ──────────────────────────────────────────────────────────────────
async function startSpeak() {
  const text  = document.getElementById('textArea').value.trim();
  const voice = getVoice();
  if (!text)  { setStatus('Enter some text first.', 'error'); return; }
  if (!voice) { setStatus('Select a voice first.', 'error'); return; }

  setSpeaking(true);
  setStatus('Generating audio with ' + voice + '...');

  try {
    const blob = await tts(text, voice);
    const url  = URL.createObjectURL(blob);
    if (currentAudio) { currentAudio.pause(); URL.revokeObjectURL(currentAudio.src); }
    currentAudio = new Audio(url);
    currentAudio.onended = () => { URL.revokeObjectURL(url); speakDone('Playback finished.'); };
    currentAudio.onerror = ()  => speakDone('Playback error.', true);
    currentAudio.play();
    setStatus('Playing...', 'ok');
  } catch (err) {
    speakDone(err.message, true);
  }
}

function stopSpeak() {
  if (currentWs)    { currentWs.close();   currentWs    = null; }
  if (currentAudio) { currentAudio.pause(); currentAudio = null; }
  speakDone('Stopped.');
}

function setSpeaking(on) {
  document.getElementById('speakBtn').disabled   = on;
  document.getElementById('stopBtn').disabled    = !on;
  document.getElementById('convertBtn').disabled = on;
}

function speakDone(msg, err) {
  setSpeaking(false);
  setStatus(msg, err ? 'error' : '');
}

// ── Convert to MP3 (download) ──────────────────────────────────────────────
async function convertToMp3() {
  const text  = document.getElementById('textArea').value.trim();
  const voice = getVoice();
  if (!text)  { setStatus('Enter some text first.', 'error'); return; }
  if (!voice) { setStatus('Select a voice first.', 'error'); return; }

  let name = document.getElementById('outputName').value.trim() || 'output.mp3';
  if (!name.endsWith('.mp3')) name += '.mp3';

  document.getElementById('convertBtn').disabled = true;
  document.getElementById('speakBtn').disabled   = true;
  setStatus('Generating MP3 with ' + voice + '...');

  try {
    const t0      = Date.now();
    const blob    = await tts(text, voice);
    const elapsed = ((Date.now() - t0) / 1000).toFixed(2);
    const url     = URL.createObjectURL(blob);
    const a       = document.createElement('a');
    a.href = url; a.download = name; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 5000);
    setStatus('Downloaded: ' + name + ' (' + elapsed + 's)', 'ok');
  } catch (err) {
    setStatus(err.message, 'error');
  } finally {
    document.getElementById('convertBtn').disabled = false;
    document.getElementById('speakBtn').disabled   = false;
  }
}

// ── Init ───────────────────────────────────────────────────────────────────
document.getElementById('filterInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') applyFilter();
});
applyFilter();
</script>
</body>
</html>
